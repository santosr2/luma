#!/usr/bin/env node

/**
 * Script to embed Luma Lua modules into TypeScript
 * Generates dist/wasm/src/modules.ts with all Luma source code
 */

const fs = require('fs');
const path = require('path');

const LUMA_ROOT = path.join(__dirname, '../../..');
const OUTPUT_FILE = path.join(__dirname, '../src/modules.ts');

// Module mappings: module name -> file path relative to repo root
const MODULES = {
  // Core
  'luma': 'luma/init.lua',
  'luma.version': 'luma/version.lua',
  
  // Compiler
  'luma.compiler': 'luma/compiler/init.lua',
  'luma.compiler.codegen': 'luma/compiler/codegen.lua',
  
  // Lexer
  'luma.lexer': 'luma/lexer/init.lua',
  'luma.lexer.native': 'luma/lexer/native.lua',
  'luma.lexer.jinja': 'luma/lexer/jinja.lua',
  'luma.lexer.tokens': 'luma/lexer/tokens.lua',
  'luma.lexer.inline_detector': 'luma/lexer/inline_detector.lua',
  'luma.lexer.trim_processor': 'luma/lexer/trim_processor.lua',
  
  // Parser
  'luma.parser': 'luma/parser/init.lua',
  'luma.parser.ast': 'luma/parser/ast.lua',
  'luma.parser.expressions': 'luma/parser/expressions.lua',
  
  // Runtime
  'luma.runtime': 'luma/runtime/init.lua',
  'luma.runtime.context': 'luma/runtime/context.lua',
  'luma.runtime.sandbox': 'luma/runtime/sandbox.lua',
  
  // Filters
  'luma.filters': 'luma/filters/init.lua',
  
  // Utils
  'luma.utils': 'luma/utils/init.lua',
  'luma.utils.compat': 'luma/utils/compat.lua',
  'luma.utils.errors': 'luma/utils/errors.lua',
  'luma.utils.warnings': 'luma/utils/warnings.lua',
};

function readModule(modulePath) {
  const fullPath = path.join(LUMA_ROOT, modulePath);
  if (!fs.existsSync(fullPath)) {
    throw new Error(`Module not found: ${fullPath}`);
  }
  return fs.readFileSync(fullPath, 'utf-8');
}

function escapeForTemplate(code) {
  // Escape backticks and ${} for TypeScript template literals
  return code
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\${/g, '\\${');
}

function generateModulesFile() {
  console.log('üì¶ Embedding Luma Lua modules...');
  
  const modules = {};
  let successCount = 0;
  let errorCount = 0;
  
  for (const [moduleName, modulePath] of Object.entries(MODULES)) {
    try {
      const code = readModule(modulePath);
      modules[moduleName] = escapeForTemplate(code);
      console.log(`  ‚úÖ ${moduleName} (${code.length} bytes)`);
      successCount++;
    } catch (error) {
      console.error(`  ‚ùå ${moduleName}: ${error.message}`);
      errorCount++;
    }
  }
  
  // Generate TypeScript file
  const output = `/**
 * Embedded Luma Lua modules
 * 
 * Auto-generated by scripts/embed-modules.js
 * DO NOT EDIT MANUALLY
 */

const modules: Record<string, string> = {
${Object.entries(modules)
    .map(([name, code]) => `  '${name}': \`${code}\`,`)
    .join('\n')}
};

export default modules;
`;
  
  fs.writeFileSync(OUTPUT_FILE, output, 'utf-8');
  
  console.log('');
  console.log(`‚úÖ Generated ${OUTPUT_FILE}`);
  console.log(`üìä ${successCount} modules embedded, ${errorCount} errors`);
  console.log(`üì¶ Total size: ${output.length} bytes`);
}

// Run
try {
  generateModulesFile();
  process.exit(0);
} catch (error) {
  console.error('‚ùå Error:', error.message);
  process.exit(1);
}
