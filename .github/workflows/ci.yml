name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Test on Lua ${{ matrix.lua-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lua-version: ["5.1", "5.2", "5.3", "5.4"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: ${{ matrix.lua-version }}

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Install dependencies
        run: |
          luarocks install busted
          luarocks install luacheck
          luarocks install luacov
          luarocks install luacov-coveralls

      - name: Create dev rockspec
        run: |
          cat > luma-dev-1.rockspec << 'EOF'
          package = "luma"
          version = "dev-1"
          source = {
            url = "."
          }
          description = {
            summary = "Lua-powered templating engine with Jinja2 compatibility",
            detailed = [[
              Luma is a powerful templating engine with clean, directive-based syntax
              and 100% Jinja2 feature parity.
            ]],
            homepage = "https://github.com/santosr2/luma",
            license = "MIT"
          }
          dependencies = {
            "lua >= 5.1"
          }
          build = {
            type = "builtin",
            modules = {
              ["luma"] = "luma/init.lua",
              ["luma.version"] = "luma/version.lua",
              ["luma.compiler.init"] = "luma/compiler/init.lua",
              ["luma.compiler.codegen"] = "luma/compiler/codegen.lua",
              ["luma.lexer.init"] = "luma/lexer/init.lua",
              ["luma.lexer.native"] = "luma/lexer/native.lua",
              ["luma.lexer.jinja"] = "luma/lexer/jinja.lua",
              ["luma.lexer.tokens"] = "luma/lexer/tokens.lua",
              ["luma.lexer.inline_detector"] = "luma/lexer/inline_detector.lua",
              ["luma.lexer.trim_processor"] = "luma/lexer/trim_processor.lua",
              ["luma.parser.init"] = "luma/parser/init.lua",
              ["luma.parser.ast"] = "luma/parser/ast.lua",
              ["luma.parser.expressions"] = "luma/parser/expressions.lua",
              ["luma.runtime.init"] = "luma/runtime/init.lua",
              ["luma.runtime.context"] = "luma/runtime/context.lua",
              ["luma.runtime.sandbox"] = "luma/runtime/sandbox.lua",
              ["luma.filters.init"] = "luma/filters/init.lua",
              ["luma.utils.init"] = "luma/utils/init.lua",
              ["luma.utils.compat"] = "luma/utils/compat.lua",
              ["luma.utils.errors"] = "luma/utils/errors.lua",
              ["luma.utils.warnings"] = "luma/utils/warnings.lua"
            },
            install = {
              bin = {
                ["luma"] = "bin/luma"
              }
            },
            copy_directories = { "spec", "examples", "benchmarks" }
          }
          EOF

      - name: Install Luma
        run: |
          luarocks make luma-dev-1.rockspec

      - name: Run Luacheck
        run: luacheck luma/ cli/ benchmarks/ --std=lua51+busted --globals=describe,it,before_each,after_each,setup,teardown --no-max-cyclomatic-complexity

      - name: Run tests with coverage
        run: busted --coverage --verbose spec/

      - name: Generate coverage report
        if: matrix.lua-version == '5.4'
        run: luacov

      - name: Upload coverage to Coveralls
        if: matrix.lua-version == '5.4'
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          file: luacov.report.out
        continue-on-error: true

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.4"

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Install Luacheck
        run: luarocks install luacheck

      - name: Run Luacheck (strict)
        run: |
          luacheck luma/ cli/ benchmarks/ \
            --std=lua51+busted \
            --globals=describe,it,before_each,after_each,setup,teardown \
            --max-line-length=120 \
            --max-code-line-length=120 \
            --max-comment-line-length=120 \
            --no-max-cyclomatic-complexity

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  complexity:
    name: Complexity Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.4"

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Install analysis tools
        run: |
          luarocks install luacheck
          sudo apt-get update
          sudo apt-get install -y cloc

      - name: Analyze code complexity
        run: |
          echo "=== Lines of Code ==="
          cloc luma/ cli/ benchmarks/ examples/ --by-file

          echo ""
          echo "=== Cyclomatic Complexity (informational) ==="
          luacheck luma/ cli/ benchmarks/ --formatter plain --no-color | grep -E "complexity|function" || echo "No issues found"

      - name: Check file sizes
        run: |
          echo "=== Large Files (>500 lines) ==="
          find luma/ cli/ benchmarks/ -name "*.lua" -type f -exec wc -l {} + | awk '$1 > 500 {print $2 " - " $1 " lines"}' || echo "No large files found"

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.4"

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Install LDoc
        run: luarocks install ldoc

      - name: Generate documentation
        run: |
          ldoc -c .ldoc luma/ || echo "LDoc not configured yet"
        continue-on-error: true

      - name: Check README
        run: |
          if [ ! -f README.md ]; then
            echo "ERROR: README.md not found"
            exit 1
          fi

          # Check for required sections
          grep -q "Installation" README.md || echo "WARNING: No Installation section"
          grep -q "Usage" README.md || echo "WARNING: No Usage section"
          grep -q "License" README.md || echo "WARNING: No License section"

  examples:
    name: Example Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.4"

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Create dev rockspec
        run: |
          cat > luma-dev-1.rockspec << 'EOF'
          package = "luma"
          version = "dev-1"
          source = {
            url = "."
          }
          description = {
            summary = "Lua-powered templating engine with Jinja2 compatibility",
            detailed = "Luma is a powerful templating engine with clean, directive-based syntax and 100% Jinja2 feature parity.",
            homepage = "https://github.com/santosr2/luma",
            license = "MIT"
          }
          dependencies = {
            "lua >= 5.1"
          }
          build = {
            type = "builtin",
            modules = {
              ["luma"] = "luma/init.lua",
              ["luma.version"] = "luma/version.lua",
              ["luma.compiler.init"] = "luma/compiler/init.lua",
              ["luma.compiler.codegen"] = "luma/compiler/codegen.lua",
              ["luma.lexer.init"] = "luma/lexer/init.lua",
              ["luma.lexer.native"] = "luma/lexer/native.lua",
              ["luma.lexer.jinja"] = "luma/lexer/jinja.lua",
              ["luma.lexer.tokens"] = "luma/lexer/tokens.lua",
              ["luma.lexer.inline_detector"] = "luma/lexer/inline_detector.lua",
              ["luma.lexer.trim_processor"] = "luma/lexer/trim_processor.lua",
              ["luma.parser.init"] = "luma/parser/init.lua",
              ["luma.parser.ast"] = "luma/parser/ast.lua",
              ["luma.parser.expressions"] = "luma/parser/expressions.lua",
              ["luma.runtime.init"] = "luma/runtime/init.lua",
              ["luma.runtime.context"] = "luma/runtime/context.lua",
              ["luma.runtime.sandbox"] = "luma/runtime/sandbox.lua",
              ["luma.filters.init"] = "luma/filters/init.lua",
              ["luma.utils.init"] = "luma/utils/init.lua",
              ["luma.utils.compat"] = "luma/utils/compat.lua",
              ["luma.utils.errors"] = "luma/utils/errors.lua",
              ["luma.utils.warnings"] = "luma/utils/warnings.lua"
            },
            install = {
              bin = {
                ["luma"] = "bin/luma"
              }
            }
          }
          EOF

      - name: Install Luma
        run: |
          luarocks make luma-dev-1.rockspec

      - name: Validate example templates
        run: |
          echo "=== Validating Example Templates ==="
          for file in examples/*.luma; do
            if [ -f "$file" ]; then
              echo "Checking syntax: $file"
              lua -e "
                local luma = require('luma')
                local f = io.open('$file', 'r')
                local source = f:read('*a')
                f:close()
                local ok, err = pcall(function()
                  luma.compile(source)
                end)
                if not ok then
                  print('  ERROR: ' .. err)
                  os.exit(1)
                else
                  print('  ✓ Valid: $file')
                end
              " || exit 1
            fi
          done

      - name: Run example scripts
        run: |
          echo "=== Running Example Scripts ==="
          for script in examples/run_*.lua; do
            if [ -f "$script" ]; then
              echo "Running: $script"
              lua "$script" > /dev/null && echo "  ✓ Success" || echo "  ✗ Failed"
            fi
          done

  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.4"

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Create dev rockspec
        run: |
          cat > luma-dev-1.rockspec << 'EOF'
          package = "luma"
          version = "dev-1"
          source = {
            url = "."
          }
          description = {
            summary = "Lua-powered templating engine with Jinja2 compatibility",
            detailed = "Luma is a powerful templating engine with clean, directive-based syntax and 100% Jinja2 feature parity.",
            homepage = "https://github.com/santosr2/luma",
            license = "MIT"
          }
          dependencies = {
            "lua >= 5.1"
          }
          build = {
            type = "builtin",
            modules = {
              ["luma"] = "luma/init.lua",
              ["luma.version"] = "luma/version.lua",
              ["luma.compiler.init"] = "luma/compiler/init.lua",
              ["luma.compiler.codegen"] = "luma/compiler/codegen.lua",
              ["luma.lexer.init"] = "luma/lexer/init.lua",
              ["luma.lexer.native"] = "luma/lexer/native.lua",
              ["luma.lexer.jinja"] = "luma/lexer/jinja.lua",
              ["luma.lexer.tokens"] = "luma/lexer/tokens.lua",
              ["luma.lexer.inline_detector"] = "luma/lexer/inline_detector.lua",
              ["luma.lexer.trim_processor"] = "luma/lexer/trim_processor.lua",
              ["luma.parser.init"] = "luma/parser/init.lua",
              ["luma.parser.ast"] = "luma/parser/ast.lua",
              ["luma.parser.expressions"] = "luma/parser/expressions.lua",
              ["luma.runtime.init"] = "luma/runtime/init.lua",
              ["luma.runtime.context"] = "luma/runtime/context.lua",
              ["luma.runtime.sandbox"] = "luma/runtime/sandbox.lua",
              ["luma.filters.init"] = "luma/filters/init.lua",
              ["luma.utils.init"] = "luma/utils/init.lua",
              ["luma.utils.compat"] = "luma/utils/compat.lua",
              ["luma.utils.errors"] = "luma/utils/errors.lua",
              ["luma.utils.warnings"] = "luma/utils/warnings.lua"
            },
            install = {
              bin = {
                ["luma"] = "bin/luma"
              }
            }
          }
          EOF

      - name: Install Luma
        run: |
          luarocks make luma-dev-1.rockspec

      - name: Run performance benchmarks
        run: |
          echo "=== Performance Benchmarks ==="
          lua benchmarks/run.lua || echo "Benchmarks completed with warnings"

          echo ""
          echo "=== Memory Profiling ==="
          lua benchmarks/memory_profile.lua || echo "Memory profiling completed"

          echo ""
          echo "=== JIT Profiling ==="
          lua benchmarks/jit_profile.lua || echo "JIT profiling completed"

          echo ""
          echo "=== Stress Testing ==="
          lua benchmarks/stress_test.lua || echo "Stress testing completed"
        continue-on-error: true

      - name: Check performance thresholds
        run: |
          echo "Performance benchmarks completed - detailed analysis available in logs"
        continue-on-error: true
